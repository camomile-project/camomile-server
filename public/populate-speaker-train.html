<html>
	<head>
		<title>jsonp test</title>
		<script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>		
        
        <script type="text/javascript">
        	function populateDB(dataAnno) {
			/*
				1) create a corpus named REPERE phase1 train
				2) for each element in the dataAnno array, create a media whose name is the video field of this array
				3) Get the media id created, and create a layer named "groundtruth speaker" with a list of the corresponding anns
				4) Allez!!
				*/
				
				var data = {};
				
				data.name = "REPERE phase1 train";
				$.ajax({
					type: 'POST',
					data: JSON.stringify(data),
					async : false,
					contentType: 'application/json',
					url: 'http://localhost:3000/corpus',						
					success: function(dataCorpus) {
						console.log('success');
						console.log(JSON.stringify(dataCorpus));
						//surely, we had a corpus id, now make a loop
						
						var corpus_id = dataCorpus._id;
						//for(var vi in dataAnno) {
						dataAnno.forEach (function(vi){
							
							var data_media = {};
							data_media.id_corpus = corpus_id;
							data_media.name = vi.video;

							$.ajax({
								type: 'POST',
								data: JSON.stringify(data_media),
								async : false,
								contentType: 'application/json',
								url: 'http://localhost:3000/corpus/' + corpus_id + '/media',						
								success: function(dataMedia) {
									console.log('success dataMedia');
//										console.log(JSON.stringify(dataMedia));
									// now it's time to add a player with a list of anns
									var media_id = dataMedia._id,
										layer_type = "groundtruth speaker";

									//console.log("vi.annotation"); console.log(vi.annotation);
									
									var anno = {
										"id_media" : media_id,
										"layer_type" : layer_type,
										"fragment_type" : "segment",
										"data_type" : "label",
										"source" : {"uri" :data_media.name, "creator" : "ELDA"},
										"annotation" : vi.annotation,
										"history" : {"name" : "ELDA", "date" : new Date()}
									};//*/
									$.ajax({
										type: 'POST',
										data: JSON.stringify(anno),
										contentType: 'application/json',
										url: 'http://localhost:3000/corpus/' + corpus_id + '/media/' + media_id + '/layerAll',
										//url: 'http://localhost:3001/corpus/media/layer/post',						
										success: function(data) {
											console.log('success in ajax post layerall');
//												console.log(JSON.stringify(data));
										}
									}); //ajax of post layerall
								} //success function of dataMedia
							}); //ajax of post media 
						}); // dataAnno.forEach (function(vi){
						
						//} //end for(var vi in dataAnno)
					} //success corpus
				}); //$.ajax({ corpus
        	}
       	</script>
        
        <script type="text/javascript">
            $(function(){				
                $('#select_addcorpus-train-speaker').click(function(e){
                    e.preventDefault();
                    console.log('select_link clicked');
                    
                    var dataAnno = [], 
                    	videoType = [];
                    
                    $.ajax({
						url: 'speaker-train.mdtm',
						dataType: 'text',
						async : false, 
						success: function(data) {
						//var letter = text.substring(index, 1);
						// do something with letter here...
							document.getElementById("myDiv").innerText = data;
							
						  	lines = data.split(/\n/gm ); //on sépare les donnés du fichier par le retour a la ligne
  							var ii = 0;
  							
  							var line0 = lines[0].split(" ");
  							var previousVideo = line0[0];
  							var videoItem = [];
  							var len = lines.length;
  							
  							console.log("len = " + len); console.log("previousVideo = " + previousVideo);
  							
						  	lines.forEach (function(value){ //pour chaque ligne on extrait les informations

								if(value.length > 0){ 
							  		// dans ce cas chaque info est séparé un espace 
							  		var line = value.split(" ");
									  /*
									  BFMTV_BFMStory_2011-07-07_175900 1 0.00 5.62 speaker na adult_male MS1 (exemple)
									  2 : start
									  3 : end 
									  4 : Type (speaker = qui parle quand , spoken = nom prononcé , head = qui apparait quand)
									  5 : na
									  6 : sexe
									  7 : name
									  */
									
									
									  // on les met dans un array
									
									var itemAnno = {
											"fragment" : {
											"start" : parseFloat(line[2])*1000,
											"end" : (parseFloat(line[3]) + parseFloat(line[2]) )* 1000
										},
										"data" : line[7]
									}
									
									
									if(previousVideo == line[0]) //the same video
										videoItem.push(itemAnno); //annotations of the same video
									else {
										var dataItem1 = {
											"video" : previousVideo,
											"annotation" : videoItem
										};	
										
										dataAnno.push(dataItem1); //each annotation item
										
										previousVideo = line[0];
										videoItem = []; videoItem.push(itemAnno); //annotations of the same video
										
									}	
									
								} //if(value.)
								
						  }); //lines.foreach
						//missing the last element	
						  if(len > 0) {
						  		var dataItem1 = {
									"video" : previousVideo,
									"annotation" : videoItem
								};	
								console.log('last video = ' +  previousVideo);
								dataAnno.push(dataItem1); //each annotation item
						  }
						  
						  console.log("data here: length = " + dataAnno.length);
						  
//						  console.log(dataAnno[134]);
						} //success function(data)
					}); //ajax
//					console.log("het roi");
					//here we need to call api-post
					/*
					1) create a corpus named REPERE phase1 train
					2) for each element in the dataAnno array, create a media whose name is the video field of this array
					3) Get the media id created, and create a layer named "groundtruth speaker" with a list of the corresponding anns
					4) Allez!!
					*/
					
					populateDB(dataAnno);
					
             	});		//click		
            });        //function
        </script>
        
    </head>
    <body>
       <!-- <div id="select_div"><a href="#" id="select_post">Click here to add a new corpus</a></div>
        <div id="select_div1"><a href="#" id="select_update">Click here to update an existing corpus</a></div>
        <div id="select_div2"><a href="#" id="select_delete">Click here to delete an existing corpus</a></div> -->
        <div id="select_div3"><a href="#" id="select_addcorpus-train-speaker">Click here populate the train speaker corpus</a></div>
        
        <div id="myDiv"></div>
    </body>
</html>